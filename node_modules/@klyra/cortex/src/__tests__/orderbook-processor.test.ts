import { describe, expect, it, beforeAll } from "@jest/globals";
import { Store } from "../core/store";
import { OrderbooksProcessor } from "../processors/orderbooks.processor";
import { OrderbookMocks } from "./mocks";

describe("OrderbookProcessor", () => {
  let store: Store;
  let orderbookProcessor: OrderbooksProcessor;

  beforeAll(() => {
    store = new Store();
    orderbookProcessor = new OrderbooksProcessor(store);
  });

  it("should be defined", () => {
    expect(OrderbooksProcessor).toBeDefined();
  });

  it("should process incoming orderbook", () => {
    orderbookProcessor.processSubscribed(OrderbookMocks.SUBSCRIBED_MESSAGE);

    const orderbook = store.getState().orderbooks;
    const marketOrderbook = orderbook["ETH-USD"];
    expect(marketOrderbook).toBeDefined();
    expect(marketOrderbook?.asks.length).toBe(10);
    expect(marketOrderbook?.bids.length).toBe(10);
    expect(marketOrderbook?.asks[0]?.price).toBe(2629.9);
    expect(marketOrderbook?.asks[0]?.size).toBe(0.415);
    expect(marketOrderbook?.bids[0]?.price).toBe(2613.6);
    expect(marketOrderbook?.bids[0]?.size).toBe(0.415);
  });

  it("should process batch update", () => {
    orderbookProcessor.processBatchUpdate(OrderbookMocks.BATCH_UPDATE_MESSAGE);
    const orderbook = store.getState().orderbooks;
    const marketOrderbook = orderbook["ETH-USD"];

    expect(marketOrderbook?.asks.length).toBe(11);
    expect(marketOrderbook?.bids.length).toBe(11);

    // These are the updated orderbook entries
    expect(marketOrderbook?.asks[1]?.price).toBe(2629.9);
    expect(marketOrderbook?.asks[1]?.size).toBe(140);
    expect(marketOrderbook?.bids[1]?.price).toBe(2613.6);
    expect(marketOrderbook?.bids[1]?.size).toBe(140);

    // These are the new orderbook entries
    expect(marketOrderbook?.asks[0]?.price).toBe(32);
    expect(marketOrderbook?.asks[0]?.size).toBe(100);
    expect(marketOrderbook?.bids[0]?.price).toBe(26032);
    expect(marketOrderbook?.bids[0]?.size).toBe(100);
  });
});
